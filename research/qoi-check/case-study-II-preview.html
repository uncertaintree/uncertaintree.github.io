<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
    <meta charset="utf-8">
    <meta name="generator" content="quarto-1.4.553">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

    <meta name="author" content="Holger Sennhenn-Reulen ">
    <meta name="dcterms.date" content="2024-12-19">

    <title>Prior-Posterior Derived-Predictive Consistency Checks for Post-Estimation Calculated Quantities of Interest (QOI-Check)</title>
    <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      div.columns{display: flex; gap: min(4vw, 1.5em);}
      div.column{flex: auto; overflow-x: auto;}
      div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
      ul.task-list{list-style: none;}
      ul.task-list li input[type="checkbox"] {
        width: 0.8em;
        margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
        vertical-align: middle;
      }
      /* CSS for syntax highlighting */
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
        }
      pre.numberSource { margin-left: 3em;  padding-left: 4px; }
      div.sourceCode
        {   }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      /* CSS for citations */
      div.csl-bib-body { }
      div.csl-entry {
        clear: both;
        margin-bottom: 0em;
      }
      .hanging-indent div.csl-entry {
        margin-left:2em;
        text-indent:-2em;
      }
      div.csl-left-margin {
        min-width:2em;
        float:left;
      }
      div.csl-right-inline {
        margin-left:2em;
        padding-left:1em;
      }
      div.csl-indent {
        margin-left: 2em;
      }    </style>

    <style>
      body.hypothesis-enabled #quarto-embed-header {
        padding-right: 36px;
      }

      #quarto-embed-header {
        height: 3em;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: solid 1px;
      }

      #quarto-embed-header h6 {
        font-size: 1.1em;
        padding-top: 0.6em;
        margin-left: 1em;
        margin-right: 1em;
        font-weight: 400;
      }

      #quarto-embed-header a.quarto-back-link,
      #quarto-embed-header a.quarto-download-embed {
        font-size: 0.8em;
        margin-top: 1em;
        margin-bottom: 1em;
        margin-left: 1em;
        margin-right: 1em;
      }

      .quarto-back-container {
        padding-left: 0.5em;
        display: flex;
      }

      .headroom {
          will-change: transform;
          transition: transform 200ms linear;
      }

      .headroom--pinned {
          transform: translateY(0%);
      }

      .headroom--unpinned {
          transform: translateY(-100%);
      }      
    </style>

    <script>
    window.document.addEventListener("DOMContentLoaded", function () {

      var header = window.document.querySelector("#quarto-embed-header");
      const titleBannerEl = window.document.querySelector("body > #title-block-header");
      if (titleBannerEl) {
        titleBannerEl.style.paddingTop = header.clientHeight + "px";
      }
      const contentEl = window.document.getElementById('quarto-content');
      for (const child of contentEl.children) {
        child.style.paddingTop = header.clientHeight + "px";
        child.style.marginTop = "1em";
      }

      // Use the article root if the `back` call doesn't work. This isn't perfect
      // but should typically work
      window.quartoBackToArticle = () => {
        var currentUrl = window.location.href;
        window.history.back();
        setTimeout(() => {
            // if location was not changed in 100 ms, then there is no history back
            if(currentUrl === window.location.href){              
                // redirect to site root
                window.location.href = "index.html";
            }
        }, 100);
      }

      const headroom = new window.Headroom(header, {
        tolerance: 5,
        onPin: function () {
        },
        onUnpin: function () {
        },
      });
      headroom.init();
    });
    </script>

    
<script src="site_libs/manuscript-notebook/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
     
      <meta name="citation_title" content="Prior-Posterior Derived-Predictive Consistency Checks for Post-Estimation Calculated Quantities of Interest (*QOI-Check*)">
<meta name="citation_author" content="Holger Sennhenn-Reulen\textsuperscript{\orcidlink{0000-0002-4782-4387}} \linebreak \textsuperscript{Northwest German Forest Research Institute (NW-FVA), Germany.}">
<meta name="citation_publication_date" content="2024-12-19">
<meta name="citation_cover_date" content="2024-12-19">
<meta name="citation_year" content="2024">
<meta name="citation_online_date" content="2024-12-19">
<meta name="citation_language" content="en">
<meta name="citation_reference" content="citation_title=Fast stable restricted maximum likelihood and marginal likelihood estimation of semiparametric generalized linear models;,citation_author=S. N. Wood;,citation_publication_date=2011;,citation_cover_date=2011;,citation_year=2011;,citation_issue=1;,citation_volume=73;,citation_journal_title=Journal of the Royal Statistical Society (B);">
<meta name="citation_reference" content="citation_title=Simulation-based calibration checking for Bayesian computation: The choice of test quantities shapes sensitivity;,citation_author=Martin Modrák;,citation_author=Angie H. Moon;,citation_author=Shinyoung Kim;,citation_author=Paul Bürkner;,citation_author=Niko Huurre;,citation_author=Kateřina Faltejsková;,citation_author=Andrew Gelman;,citation_author=Aki Vehtari;,citation_publication_date=2023;,citation_cover_date=2023;,citation_year=2023;,citation_doi=10.1214/23-BA1404;,citation_volume=Advance publication;,citation_journal_title=Bayesian Analysis;">
<meta name="citation_reference" content="citation_title=brms: An R Package for Bayesian Multilevel Models Using Stan;,citation_author=Paul-Christian Bürkner;,citation_publication_date=2017;,citation_cover_date=2017;,citation_year=2017;,citation_issue=1;,citation_doi=10.18637/jss.v080.i01;,citation_volume=80;,citation_journal_title=Journal of Statistical Software;">
<meta name="citation_reference" content="citation_title=Advanced Bayesian Multilevel Modeling with the R Package brms;,citation_author=Paul-Christian Bürkner;,citation_publication_date=2018;,citation_cover_date=2018;,citation_year=2018;,citation_issue=1;,citation_doi=10.32614/RJ-2018-017;,citation_volume=10;,citation_journal_title=The R Journal;">
<meta name="citation_reference" content="citation_title=Bayesian Item Response Modeling in R with brms and Stan;,citation_author=Paul-Christian Bürkner;,citation_publication_date=2021;,citation_cover_date=2021;,citation_year=2021;,citation_issue=5;,citation_doi=10.18637/jss.v100.i05;,citation_volume=100;,citation_journal_title=Journal of Statistical Software;">
<meta name="citation_reference" content="citation_title=cmdstanr: R Interface to ’CmdStan’;,citation_author=Jonah Gabry;,citation_author=Rok Češnovar;,citation_author=Andrew Johnson;,citation_author=Steve Bronder;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://mc-stan.org/cmdstanr/;">
<meta name="citation_reference" content="citation_title=ggplot2: Elegant Graphics for Data Analysis;,citation_author=Hadley Wickham;,citation_publication_date=2016;,citation_cover_date=2016;,citation_year=2016;,citation_fulltext_html_url=https://ggplot2.tidyverse.org;,citation_isbn=978-3-319-24277-4;">
<meta name="citation_reference" content="citation_title=colorspace: A Toolbox for Manipulating and Assessing Colors and Palettes;,citation_author=Achim Zeileis;,citation_author=Jason C. Fisher;,citation_author=Kurt Hornik;,citation_author=Ross Ihaka;,citation_author=Claire D. McWhite;,citation_author=Paul Murrell;,citation_author=Reto Stauffer;,citation_author=Claus O. Wilke;,citation_publication_date=2020;,citation_cover_date=2020;,citation_year=2020;,citation_issue=1;,citation_doi=10.18637/jss.v096.i01;,citation_volume=96;,citation_journal_title=Journal of Statistical Software;">
<meta name="citation_reference" content="citation_title=Escaping RGBland: Selecting Colors for Statistical Graphics;,citation_author=Achim Zeileis;,citation_author=Kurt Hornik;,citation_author=Paul Murrell;,citation_publication_date=2009;,citation_cover_date=2009;,citation_year=2009;,citation_issue=9;,citation_doi=10.1016/j.csda.2008.11.033;,citation_volume=53;,citation_journal_title=Computational Statistics &amp;amp;amp; Data Analysis;">
<meta name="citation_reference" content="citation_title=Somewhere over the Rainbow: How to Make Effective Use of Colors in Meteorological Visualizations;,citation_author=Reto Stauffer;,citation_author=Georg J. Mayr;,citation_author=Markus Dabernig;,citation_author=Achim Zeileis;,citation_publication_date=2009;,citation_cover_date=2009;,citation_year=2009;,citation_issue=2;,citation_doi=10.1175/BAMS-D-13-00155.1;,citation_volume=96;,citation_journal_title=Bulletin of the American Meteorological Society;">
<meta name="citation_reference" content="citation_title=A Unifying Framework for Parallel and Distributed Processing in R using Futures;,citation_author=Henrik Bengtsson;,citation_publication_date=2021;,citation_cover_date=2021;,citation_year=2021;,citation_fulltext_html_url=https://doi.org/10.32614/RJ-2021-048;,citation_issue=2;,citation_doi=10.32614/RJ-2021-048;,citation_volume=13;,citation_journal_title=The R Journal;">
<meta name="citation_reference" content="citation_title=R: A Language and Environment for Statistical Computing (Version 4.4.1);,citation_author=R Core Team;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_publisher=R Foundation for Statistical Computing;">
<meta name="citation_reference" content="citation_title=Quarto (Version 1.4.553);,citation_author=J. J. Allaire;,citation_author=Charles Teague;,citation_author=Carlos Scheidegger;,citation_author=Yihui Xie;,citation_author=Christophe Dervieux;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://github.com/quarto-dev/quarto-cli;,citation_doi=10.5281/zenodo.5960048;">
<meta name="citation_reference" content="citation_title=Stan: A Probabilistic Programming Language;,citation_author=Bob Carpenter;,citation_author=Andrew Gelman;,citation_author=Matthew D. Hoffman;,citation_author=Daniel Lee;,citation_author=Ben Goodrich;,citation_author=Michael Betancourt;,citation_author=Marcus Brubaker;,citation_author=Jiqiang Guo;,citation_author=Peter Li;,citation_author=Allen Riddell;,citation_publication_date=2017-01;,citation_cover_date=2017-01;,citation_year=2017;,citation_doi=10.18637/jss.v076.i01;,citation_issn=1548-7660;,citation_volume=76;,citation_language=en-US;,citation_journal_title=Journal of Statistical Software;">
<meta name="citation_reference" content="citation_title=Calibrated Model Criticism Using Split Predictive Checks;,citation_author=Jiawei Li;,citation_author=Jonathan H. Huggins;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://arxiv.org/abs/2203.15897;">
</head>

  <body class="quarto-notebook">
    <div id="quarto-embed-header" class="headroom fixed-top bg-primary">
      
      <a onclick="window.quartoBackToArticle(); return false;" class="btn btn-primary quarto-back-link" href=""><i class="bi bi-caret-left"></i> Back to Article</a>
      <h6><i class="bi bi-journal-code"></i> Article Notebook</h6>

            <a href="./case-study-II.qmd" class="btn btn-primary quarto-download-embed" download="case-study-II.qmd">Download Source</a>
          </div>

     <header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Prior-Posterior Derived-Predictive Consistency Checks for Post-Estimation Calculated Quantities of Interest (<em>QOI-Check</em>)</h1>
            <p class="subtitle lead">Case Study II: ANOVA Decomposition of Bivariate Spline</p>
          </div>

    
    <div class="quarto-title-meta-container">
      <div class="quarto-title-meta-column-start">
            <div class="quarto-title-meta-author">
          <div class="quarto-title-meta-heading">Author</div>
          <div class="quarto-title-meta-heading">Affiliation</div>
          
                <div class="quarto-title-meta-contents">
            <p class="author">Holger Sennhenn-Reulen  <a href="mailto:holger dot sennhenn at nw minus fva dot de" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0002-4782-4387" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
          </div>
                <div class="quarto-title-meta-contents">
                    <p class="affiliation">
                        Northwest German Forest Research Institute (NW-FVA)
                      </p>
                  </div>
                    </div>
        
        <div class="quarto-title-meta">

                      
                <div>
            <div class="quarto-title-meta-heading">Published</div>
            <div class="quarto-title-meta-contents">
              <p class="date">December 19, 2024</p>
            </div>
          </div>
          
                
              </div>
      </div>
      <div class="quarto-title-meta-column-end quarto-other-formats-target">
      </div>
    </div>



    <div class="quarto-other-links-text-target">
    </div>  </div>
</header><div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#intro" id="toc-intro" class="nav-link active" data-scroll-target="#intro">Intro</a>
  <ul class="collapse">
  <li><a href="#software" id="toc-software" class="nav-link" data-scroll-target="#software">Software</a></li>
  </ul></li>
  <li><a href="#organize-r-session" id="toc-organize-r-session" class="nav-link" data-scroll-target="#organize-r-session">Organize R Session</a></li>
  <li><a href="#data-generator" id="toc-data-generator" class="nav-link" data-scroll-target="#data-generator">Data Generator</a></li>
  <li><a href="#backend" id="toc-backend" class="nav-link" data-scroll-target="#backend">Backend</a></li>
  <li><a href="#visualize-bivariate-smooth-at-first-four-simulation-runs" id="toc-visualize-bivariate-smooth-at-first-four-simulation-runs" class="nav-link" data-scroll-target="#visualize-bivariate-smooth-at-first-four-simulation-runs">Visualize bivariate smooth at first four simulation runs</a></li>
  <li><a href="#qoi-check" id="toc-qoi-check" class="nav-link" data-scroll-target="#qoi-check">QOI-Check</a></li>
  <li><a href="#visualise-isolated-effect-of-x-for-1st-simulation-run" id="toc-visualise-isolated-effect-of-x-for-1st-simulation-run" class="nav-link" data-scroll-target="#visualise-isolated-effect-of-x-for-1st-simulation-run">Visualise ‘isolated effect’ of <code>x</code> for 1st simulation run</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content quarto-banner-title-block" id="quarto-document-content">      

       <section id="intro" class="level1">
<h1>Intro</h1>
<p>Relevant parts of the code given here is inspired by the resources of the great <em>SBC</em> package <span class="citation" data-cites="ModrakEtAl2023">(<a href="#ref-ModrakEtAl2023" role="doc-biblioref">Modrák et al., 2023</a>)</span> published at <a href="https://hyunjimoon.github.io/SBC/index.html">https://hyunjimoon.github.io/SBC/index.html</a>.</p>
<p>Also, coding of posterior p-values is inspired by the split predictive check <span class="citation" data-cites="LiHuggins2024">(<a href="#ref-LiHuggins2024" role="doc-biblioref">Li &amp; Huggins, 2024</a>)</span> R code published at <a href="https://github.com/TARPS-group/split-predictive-checks">https://github.com/TARPS-group/split-predictive-checks</a>.</p>
<section id="software" class="level2">
<h2 class="anchored" data-anchor-id="software">Software</h2>
<p>We use the statistical software environment <em>R</em> <span class="citation" data-cites="RCoreTeam2024">(<a href="#ref-RCoreTeam2024" role="doc-biblioref">R Core Team, 2024</a>)</span>, and R add-on packages <em>SBC</em> <span class="citation" data-cites="ModrakEtAl2023">(<a href="#ref-ModrakEtAl2023" role="doc-biblioref">Modrák et al., 2023</a>)</span>, <em>brms</em> <span class="citation" data-cites="Buerkner2017 Buerkner2018 Buerkner2021">(<a href="#ref-Buerkner2017" role="doc-biblioref">Bürkner, 2017</a>, <a href="#ref-Buerkner2018" role="doc-biblioref">2018</a>, <a href="#ref-Buerkner2021" role="doc-biblioref">2021</a>)</span>, <em>mgcv</em> <span class="citation" data-cites="Wood2011">(<a href="#ref-Wood2011" role="doc-biblioref">Wood, 2011</a>)</span>, <em>cmdstanr</em> <span class="citation" data-cites="GabryEtAl2024">(<a href="#ref-GabryEtAl2024" role="doc-biblioref">Gabry et al., 2024</a>)</span>, <em>ggplot2</em> <span class="citation" data-cites="Wickham2016">(<a href="#ref-Wickham2016" role="doc-biblioref">Wickham, 2016</a>)</span>, <em>colorspace</em> <span class="citation" data-cites="StaufferEtAl2009">(<a href="#ref-StaufferEtAl2009" role="doc-biblioref">Stauffer et al., 2009</a>)</span>, and <em>future</em> <span class="citation" data-cites="Bengtsson2021">(<a href="#ref-Bengtsson2021" role="doc-biblioref">Bengtsson, 2021</a>)</span>.</p>
<p>This document is produced using <em>Quarto</em> <span class="citation" data-cites="AllaireEtAl2024">(<a href="#ref-AllaireEtAl2024" role="doc-biblioref">Allaire et al., 2024</a>)</span>.</p>
</section>
</section>
<section id="organize-r-session" class="level1">
<h1>Organize R Session</h1>
<div class="cell-container"><div class="cell-decorator"><pre>In [1]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># setwd("~/Dropbox/forschung/simulation_based_calibration/application_D_post_estimation_calculation")</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"~/Dropbox/forschung/reference_grid_posterior_predictive_check/application_B_beta_beta_gaussian_additive_model"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mgcv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Lade nötiges Paket: nlme</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>This is mgcv 1.9-1. For overview type 'help("mgcv-package")'.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"SBC"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"brms"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Lade nötiges Paket: Rcpp</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading 'brms' package (version 2.21.0). Useful instructions
can be found by typing help('brms'). A more detailed introduction
to the package is available through vignette('brms_overview').</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attache Paket: 'brms'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Die folgenden Objekte sind maskiert von 'package:mgcv':

    s, t2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Das folgende Objekt ist maskiert 'package:stats':

    ar</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"cmdstanr"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>This is cmdstanr version 0.8.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStanR documentation and vignettes: mc-stan.org/cmdstanr</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStan path: /home/hsennhenn/.cmdstan/cmdstan-2.35.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStan version: 2.35.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
A newer version of CmdStan is available. See ?install_cmdstan() to install it.
To disable this check set option or environment variable cmdstanr_no_ver_check=TRUE.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"colorspace"</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"cowplot"</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"future"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<p>Load packages:</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [2]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mgcv"</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"SBC"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"brms"</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"cmdstanr"</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"colorspace"</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"cowplot"</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"future"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<p>Settings:</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [3]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">brms.backend =</span> <span class="st">"cmdstanr"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Using parallel processing</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">SBC.min_chunk_size =</span> <span class="dv">5</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup caching of results</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>cache_dir <span class="ot">&lt;-</span> <span class="st">"./SBC_cache"</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(cache_dir)) {</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(cache_dir)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [4]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">brms.backend =</span> <span class="st">"cmdstanr"</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Using parallel processing</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">SBC.min_chunk_size =</span> <span class="dv">5</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup caching of results</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>cache_dir <span class="ot">&lt;-</span> <span class="st">"./SBC_cache"</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(cache_dir)) {</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(cache_dir)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<p>Data preparation function for graphical uniformity checks:</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [5]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convenient wrapper around mgcv::PredictMat</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>PredictMat <span class="ot">&lt;-</span> <span class="cf">function</span>(object, data, ...) {</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">rm_attr</span>(data, <span class="st">"terms"</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">PredictMat</span>(object, <span class="at">data =</span> data, ...)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">dim</span>(out)) <span class="sc">&lt;</span> <span class="dv">2</span>L) {</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fixes issue #494</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    out <span class="ot">&lt;-</span> <span class="fu">matrix</span>(out, <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># convenient wrapper around mgcv::smoothCon</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>smoothCon <span class="ot">&lt;-</span> <span class="cf">function</span>(object, data, ...) {</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">rm_attr</span>(data, <span class="st">"terms"</span>)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">c</span>(object<span class="sc">$</span>term, object<span class="sc">$</span>by), <span class="st">"NA"</span>)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (v <span class="cf">in</span> vars) {</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is_like_factor</span>(data[[v]])) {</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>      <span class="co"># allow factor-like variables #562</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>      data[[v]] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data[[v]])</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">inherits</span>(data[[v]], <span class="st">"difftime"</span>)) {</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>      <span class="co"># mgcv cannot handle 'difftime' variables</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>      data[[v]] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data[[v]])</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>  mgcv<span class="sc">::</span><span class="fu">smoothCon</span>(object, <span class="at">data =</span> data, ...)</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Aid prediction from smooths represented as 'type = 2'</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="co"># code obtained from the doc of ?mgcv::smooth2random</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="co"># @param sm output of mgcv::smoothCon</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a><span class="co"># @param re output of mgcv::smooth2random</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a><span class="co"># @param data new data supplied for prediction</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a><span class="co"># @return A list of the same structure as returned by mgcv::smooth2random</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>s2rPred <span class="ot">&lt;-</span> <span class="cf">function</span>(sm, re, data) {</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>  <span class="co">#sm = sm[[1]] ## for check!</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>  <span class="co">#re = hmmmm ## for check!</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">#data = nd ## for check!</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># prediction matrix for new data</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">PredictMat</span>(sm, data)</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># transform to RE parameterization</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(re<span class="sc">$</span>trans.U)) {</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">&lt;-</span> X <span class="sc">%*%</span> re<span class="sc">$</span>trans.U</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(re<span class="sc">$</span>trans.D)) {</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># regression spline without penalization</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>    out <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Xf =</span> X)</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">t</span>(X) <span class="sc">*</span> re<span class="sc">$</span>trans.D)</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># re-order columns according to random effect re-ordering</span></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>    X[, re<span class="sc">$</span>rind] <span class="ot">&lt;-</span> X[, re<span class="sc">$</span>pen.ind <span class="sc">!=</span> <span class="dv">0</span>]</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># re-order penalization index in same way</span></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>    pen.ind <span class="ot">&lt;-</span> re<span class="sc">$</span>pen.ind</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>    pen.ind[re<span class="sc">$</span>rind] <span class="ot">&lt;-</span> pen.ind[pen.ind <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># start returning the object</span></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>    Xf <span class="ot">&lt;-</span> X[, <span class="fu">which</span>(re<span class="sc">$</span>pen.ind <span class="sc">==</span> <span class="dv">0</span>), drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>    out <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">rand =</span> <span class="fu">list</span>(), <span class="at">Xf =</span> Xf)</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(re<span class="sc">$</span>rand)) {</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>      <span class="co"># loop over random effect matrices</span></span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>      out<span class="sc">$</span>rand[[i]] <span class="ot">&lt;-</span> X[, <span class="fu">which</span>(pen.ind <span class="sc">==</span> i), drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>      <span class="fu">attr</span>(out<span class="sc">$</span>rand[[i]], <span class="st">"s.label"</span>) <span class="ot">&lt;-</span> <span class="fu">attr</span>(re<span class="sc">$</span>rand[[i]], <span class="st">"s.label"</span>)</span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(out<span class="sc">$</span>rand) <span class="ot">&lt;-</span> <span class="fu">names</span>(re<span class="sc">$</span>rand)</span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<p>Data preparation function for graphical uniformity checks:</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [6]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="do">## from https://github.com/TeemuSailynoja/simultaneous-confidence-bands/tree/main</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>dat_ecdf_diff <span class="ot">&lt;-</span> <span class="cf">function</span> (x, <span class="at">variables =</span> <span class="cn">NULL</span>, <span class="at">K =</span> <span class="cn">NULL</span>, </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">gamma =</span> <span class="cn">NULL</span>, <span class="at">prob =</span> <span class="fl">0.95</span>, </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">combine_variables =</span> <span class="cn">NULL</span>, </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">ecdf_alpha =</span> <span class="cn">NULL</span>, ..., </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">parameters =</span> <span class="cn">NULL</span>) {</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(parameters)) {</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"The `parameters` argument is deprecated use `variables` instead."</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(variables)) {</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>      variables <span class="ot">&lt;-</span> parameters</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  ecdf_data <span class="ot">&lt;-</span> <span class="fu">data_for_ecdf_plots</span>(x, <span class="at">variables =</span> variables,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">prob =</span> prob, <span class="at">K =</span> K, <span class="at">gamma =</span> gamma, </span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">combine_variables =</span> combine_variables,</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">ecdf_alpha =</span> ecdf_alpha, ...)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (ecdf_data<span class="sc">$</span>N <span class="sc">&lt;</span> <span class="dv">50</span> <span class="sc">&amp;&amp;</span> <span class="fu">is.null</span>(K)) {</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"With less than 50 simulations, we recommend using plot_ecdf as it has better fidelity.</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Disable this message by explicitly setting the K parameter. "</span>,</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"You can use the strings </span><span class="sc">\"</span><span class="st">max</span><span class="sc">\"</span><span class="st"> (high fidelity) or </span><span class="sc">\"</span><span class="st">min</span><span class="sc">\"</span><span class="st"> (nicer plot) or choose a specific integer."</span>)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">&lt;-</span> ecdf_data<span class="sc">$</span>N</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> ecdf_data<span class="sc">$</span>K</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  z <span class="ot">&lt;-</span> ecdf_data<span class="sc">$</span>z</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>  ecdf_df <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(ecdf_data<span class="sc">$</span>ecdf_df, <span class="at">z_diff =</span> ecdf <span class="sc">-</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>                             z, <span class="at">type =</span> <span class="st">"sample ECDF"</span>)</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  limits_df_trans <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(ecdf_data<span class="sc">$</span>limits_df, </span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">ymax =</span> upper <span class="sc">-</span> uniform_val, </span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">ymin =</span> lower <span class="sc">-</span> uniform_val, </span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">type =</span> <span class="st">"theoretical CDF"</span>)</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">'ecdf_df'</span> <span class="ot">=</span> ecdf_df,</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>              <span class="st">'limits_df_trans'</span> <span class="ot">=</span> limits_df_trans))</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [7]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_ecdf_diff_green &lt;- function (x, variables = NULL, K = NULL, gamma = NULL, prob = 0.95, </span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co">#                                   size = 1, alpha = 0.33, combine_variables = NULL, ecdf_alpha = NULL, </span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co">#                                   ..., parameters = NULL) {</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (!is.null(parameters)) {</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     warning("The `parameters` argument is deprecated use `variables` instead.")</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (is.null(variables)) {</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co">#       variables &lt;- parameters</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   ecdf_data &lt;- data_for_ecdf_plots(x, variables = variables, </span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co">#                                    prob = prob, K = K, gamma = gamma, combine_variables = combine_variables, </span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="co">#                                    ecdf_alpha = ecdf_alpha, ...)</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (ecdf_data$N &lt; 50 &amp;&amp; is.null(K)) {</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co">#     message("With less than 50 simulations, we recommend using plot_ecdf as it has better fidelity.\n", </span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="co">#             "Disable this message by explicitly setting the K parameter. ", </span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co">#             "You can use the strings \"max\" (high fidelity) or \"min\" (nicer plot) or choose a specific integer.")</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co">#   N &lt;- ecdf_data$N</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="co">#   K &lt;- ecdf_data$K</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="co">#   z &lt;- ecdf_data$z</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="co">#   ecdf_df &lt;- dplyr::mutate(ecdf_data$ecdf_df, z_diff = ecdf - </span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="co">#                              z, type = "sample ECDF")</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="co">#   limits_df_trans &lt;- dplyr::mutate(ecdf_data$limits_df, ymax = upper - </span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="co">#                                      uniform_val, ymin = lower - uniform_val, type = "theoretical CDF")</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="co">#   ggplot(ecdf_df, aes(color = type, fill = type)) + </span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a><span class="co">#     geom_ribbon(data = limits_df_trans, </span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="co">#                 aes(x = x, ymax = ymax, ymin = ymin), alpha = alpha, </span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="co">#                 linewidth = size) + </span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a><span class="co">#     geom_step(aes(x = z, y = z_diff, group = variable, </span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a><span class="co">#                   alpha = alpha)) + </span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="co">#     scale_color_manual(name = "", </span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a><span class="co">#                        values = rlang::set_names(c("darkseagreen", "black"), c("theoretical CDF", "sample ECDF")), </span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="co">#                        labels = c(`theoretical CDF` = expression("Theoretical CDF"), </span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="co">#                                   `sample ECDF` = expression("Sample ECDF"))) + </span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a><span class="co">#     scale_fill_manual(name = "", values = c(`theoretical CDF` = "darkseagreen3", `sample ECDF` = "transparent"), </span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a><span class="co">#                       labels = c(`theoretical CDF` = expression("Theoretical CDF"), </span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a><span class="co">#                                  `sample ECDF` = expression("Sample ECDF"))) + </span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a><span class="co">#     scale_alpha_identity() + </span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a><span class="co">#     xlab(NULL) + </span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a><span class="co">#     ylab(NULL) + </span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a><span class="co">#     facet_wrap( ~ group, scales = "free_y")</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="data-generator" class="level1">
<h1>Data Generator</h1>
<div class="cell-container"><div class="cell-decorator"><pre>In [8]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>f_generate_y <span class="ot">&lt;-</span> <span class="cf">function</span>(sim_df, </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                         eta, </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                         sigma) {</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  sim_df<span class="sc">$</span><span class="st">'mu_y'</span> <span class="ot">&lt;-</span> eta</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  sim_df<span class="sc">$</span><span class="st">'sigma_y'</span> <span class="ot">&lt;-</span> <span class="fu">rep</span>(sigma, <span class="fu">nrow</span>(sim_df))</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  sim_df<span class="sc">$</span><span class="st">'y'</span> <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">nrow</span>(sim_df), </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>                      <span class="at">mean =</span> sim_df<span class="sc">$</span><span class="st">'mu_y'</span>, </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>                      <span class="at">sd =</span> sim_df<span class="sc">$</span><span class="st">'sigma_y'</span>)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(sim_df)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>f_generate_xz <span class="ot">&lt;-</span> <span class="cf">function</span>(N, b_Intercept, phi) {</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">plogis</span>(b_Intercept)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">rbeta</span>(<span class="at">n =</span> N, <span class="at">shape1 =</span> mu <span class="sc">*</span> phi, <span class="at">shape2 =</span> (<span class="dv">1</span> <span class="sc">-</span> mu) <span class="sc">*</span> phi))</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>f_generate_one_sim <span class="ot">&lt;-</span> <span class="cf">function</span>(N) {</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  prior_mu <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">'b_x_Intercept'</span> <span class="ot">=</span> <span class="dv">0</span>, </span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'b_z_Intercept'</span> <span class="ot">=</span> <span class="sc">-</span><span class="fl">1.1</span>,</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'b_y_Intercept'</span> <span class="ot">=</span> .<span class="dv">5</span>,</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'bs_y_sxz_1'</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'bs_y_sxz_2'</span> <span class="ot">=</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'sds_y_sxz_1'</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'phi_x'</span> <span class="ot">=</span> <span class="dv">3</span>,</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'phi_z'</span> <span class="ot">=</span> <span class="dv">3</span>,</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'sigma_y'</span> <span class="ot">=</span> .<span class="dv">1</span>)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>  prior_sd <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">'b_x_Intercept'</span> <span class="ot">=</span> .<span class="dv">001</span>, </span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'b_z_Intercept'</span> <span class="ot">=</span> .<span class="dv">001</span>,</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'b_y_Intercept'</span> <span class="ot">=</span> .<span class="dv">1</span>,</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'bs_y_sxz_1'</span> <span class="ot">=</span> .<span class="dv">1</span>,</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'bs_y_sxz_2'</span> <span class="ot">=</span> .<span class="dv">1</span>,</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'sds_y_sxz_1'</span> <span class="ot">=</span> .<span class="dv">1</span>,</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'phi_x'</span> <span class="ot">=</span> .<span class="dv">001</span>,</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'phi_z'</span> <span class="ot">=</span> .<span class="dv">001</span>,</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'sigma_y'</span> <span class="ot">=</span> .<span class="dv">01</span>)</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>  b_y_Intercept <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">1</span>, </span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>                         <span class="at">mean =</span> prior_mu<span class="sc">$</span>b_y_Intercept, </span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>                         <span class="at">sd =</span> prior_sd<span class="sc">$</span>b_y_Intercept)</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>  bs_y_sxz_1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">1</span>, </span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>                      <span class="at">mean =</span> prior_mu<span class="sc">$</span>bs_y_sxz_1, </span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>                      <span class="at">sd =</span> prior_sd<span class="sc">$</span>bs_y_sxz_1)</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>  bs_y_sxz_2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">1</span>, </span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>                      <span class="at">mean =</span> prior_mu<span class="sc">$</span>bs_y_sxz_2, </span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>                      <span class="at">sd =</span> prior_sd<span class="sc">$</span>bs_y_sxz_2)</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>  sds_y_sxz_1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">1</span>, </span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>                       <span class="at">mean =</span> prior_mu<span class="sc">$</span>sds_y_sxz_1, </span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sd =</span> prior_sd<span class="sc">$</span>sds_y_sxz_1)</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>  sds_y_sxz_1 <span class="ot">&lt;-</span> <span class="fu">abs</span>(sds_y_sxz_1)</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>  sigma_y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">1</span>, </span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>                   <span class="at">mean =</span> prior_mu<span class="sc">$</span>sigma_y, </span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>                   <span class="at">sd =</span> prior_sd<span class="sc">$</span>sigma_y)</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>  b_x_Intercept <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">1</span>, </span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>                         <span class="at">mean =</span> prior_mu<span class="sc">$</span>b_x_Intercept, </span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>                         <span class="at">sd =</span> prior_sd<span class="sc">$</span>b_x_Intercept)</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>  phi_x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">1</span>, </span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>                 <span class="at">mean =</span> prior_mu<span class="sc">$</span>phi_x, </span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>                 <span class="at">sd =</span> prior_sd<span class="sc">$</span>phi_x)</span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>  phi_x <span class="ot">&lt;-</span> <span class="fu">abs</span>(phi_x)</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>  b_z_Intercept <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">1</span>, </span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>                         <span class="at">mean =</span> prior_mu<span class="sc">$</span>b_z_Intercept, </span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>                         <span class="at">sd =</span> prior_sd<span class="sc">$</span>b_z_Intercept)</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>  phi_z <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">1</span>, </span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>                 <span class="at">mean =</span> prior_mu<span class="sc">$</span>phi_z, </span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>                 <span class="at">sd =</span> prior_sd<span class="sc">$</span>phi_z)</span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>  phi_z <span class="ot">&lt;-</span> <span class="fu">abs</span>(phi_z)</span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">f_generate_xz</span>(N, b_x_Intercept, phi_x)</span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>  z <span class="ot">&lt;-</span> <span class="fu">f_generate_xz</span>(N, b_z_Intercept, phi_z)</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>  dat_xz <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">'x'</span> <span class="ot">=</span> x, <span class="st">'z'</span> <span class="ot">=</span> z)</span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>  sm <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">smoothCon</span>(<span class="at">object =</span> <span class="fu">s</span>(x, z, <span class="at">k =</span> <span class="dv">10</span>), <span class="at">data =</span> dat_xz,</span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>                        <span class="at">absorb.cons =</span> <span class="cn">TRUE</span>, <span class="at">modCon =</span> <span class="dv">3</span>, <span class="at">diagonal.penalty =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a>  sm2r <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">smooth2random</span>(<span class="at">object =</span> sm[[<span class="dv">1</span>]], <span class="at">vnames =</span> <span class="fu">c</span>(<span class="st">'x'</span>, <span class="st">'z'</span>), <span class="at">type =</span> <span class="dv">2</span>)</span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>  Xf <span class="ot">&lt;-</span> sm2r[[<span class="st">'Xf'</span>]]</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>  Xr <span class="ot">&lt;-</span> sm2r[[<span class="st">'rand'</span>]][[<span class="st">'Xr'</span>]]</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>  s_y_sxz <span class="ot">&lt;-</span> <span class="fu">t</span>(MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">mu =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">ncol</span>(Xr)), </span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>                             <span class="at">Sigma =</span> sds_y_sxz_1 <span class="sc">*</span> <span class="fu">diag</span>(<span class="fu">ncol</span>(Xr))))</span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>  variables <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">'b_y_Intercept'</span> <span class="ot">=</span> b_y_Intercept, </span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'bs_y_sxz_1'</span> <span class="ot">=</span> bs_y_sxz_1, </span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'bs_y_sxz_2'</span> <span class="ot">=</span> bs_y_sxz_2,</span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'sds_y_sxz_1'</span> <span class="ot">=</span> sds_y_sxz_1,</span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'s_y_sxz[1]'</span> <span class="ot">=</span> s_y_sxz[<span class="dv">1</span>, <span class="dv">1</span>], </span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'s_y_sxz[2]'</span> <span class="ot">=</span> s_y_sxz[<span class="dv">1</span>, <span class="dv">2</span>], </span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'s_y_sxz[3]'</span> <span class="ot">=</span> s_y_sxz[<span class="dv">1</span>, <span class="dv">3</span>],</span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'s_y_sxz[4]'</span> <span class="ot">=</span> s_y_sxz[<span class="dv">1</span>, <span class="dv">4</span>],</span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'s_y_sxz[5]'</span> <span class="ot">=</span> s_y_sxz[<span class="dv">1</span>, <span class="dv">5</span>],</span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'s_y_sxz[6]'</span> <span class="ot">=</span> s_y_sxz[<span class="dv">1</span>, <span class="dv">6</span>],</span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'s_y_sxz[7]'</span> <span class="ot">=</span> s_y_sxz[<span class="dv">1</span>, <span class="dv">7</span>],</span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'sigma_y'</span> <span class="ot">=</span> sigma_y,</span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'b_x_Intercept'</span> <span class="ot">=</span> b_x_Intercept, </span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'b_z_Intercept'</span> <span class="ot">=</span> b_z_Intercept,</span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'phi_x'</span> <span class="ot">=</span> phi_x,</span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'phi_z'</span> <span class="ot">=</span> phi_z)</span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a>  etaf <span class="ot">&lt;-</span> Xf <span class="sc">%*%</span> <span class="fu">c</span>(bs_y_sxz_1, bs_y_sxz_2)</span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a>  etar <span class="ot">&lt;-</span> Xr <span class="sc">%*%</span> <span class="fu">t</span>(s_y_sxz)</span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a>  eta <span class="ot">&lt;-</span> b_y_Intercept <span class="sc">+</span> etaf <span class="sc">+</span> etar</span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">'variables'</span> <span class="ot">=</span> variables,</span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a>              <span class="st">'generated'</span> <span class="ot">=</span> <span class="fu">f_generate_y</span>(<span class="at">sim_df =</span> dat_xz, </span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">eta =</span> eta, </span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">sigma =</span> sigma_y)))</span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a>f_generate_n_sims <span class="ot">&lt;-</span> <span class="fu">SBC_generator_function</span>(f_generate_one_sim, </span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">N =</span> <span class="dv">1000</span>)</span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a>datasets <span class="ot">&lt;-</span> <span class="fu">generate_datasets</span>(f_generate_n_sims, <span class="dv">20</span>)</span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(datasets<span class="sc">$</span>generated[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          x           z      mu_y   sigma_y          y
1 0.6428125 0.471219239 0.3496019 0.1012929 0.33045945
2 0.1542820 0.158118671 0.1796588 0.1012929 0.10296001
3 0.3846568 0.116883626 0.1478711 0.1012929 0.22810111
4 0.3718601 0.228222288 0.2942474 0.1012929 0.43050453
5 0.4644184 0.003815211 0.1276784 0.1012929 0.05732729
6 0.6761364 0.082005730 1.0524761 0.1012929 1.00740764</code></pre>
</div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [9]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cowplot::plot_grid(ggplot(data = subset(datasets$generated[[1]], w_y &gt; .5), </span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co">#                           aes(x = x, y = z, color = y)) + </span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">#                      geom_point() + </span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">#                      colorspace::scale_color_continuous_divergingx() + </span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">#                      theme(legend.position = "top"),</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co">#                    ggplot(data = subset(datasets$generated[[2]], w_y &gt; .5), </span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co">#                           aes(x = x, y = z, color = y)) + </span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co">#                      geom_point() + </span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co">#                      colorspace::scale_color_continuous_divergingx() + </span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co">#                      theme(legend.position = "top"),</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co">#                    ggplot(data = subset(datasets$generated[[3]], w_y &gt; .5), </span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="co">#                           aes(x = x, y = z, color = y)) + </span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="co">#                      geom_point() + </span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="co">#                      colorspace::scale_color_continuous_divergingx() + </span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="co">#                      theme(legend.position = "top"),</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="co">#                    ggplot(data = subset(datasets$generated[[4]], w_y &gt; .5), </span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="co">#                           aes(x = x, y = z, color = y)) + </span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="co">#                      geom_point() + </span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="co">#                      colorspace::scale_color_continuous_divergingx() + </span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="co">#                      theme(legend.position = "top"))</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="co"># priors &lt;- </span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="co">#   prior(normal(.5,.1), class = "Intercept", resp = "y") + </span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="co">#   prior(normal(.1,.01), class = "sigma", resp = "y")</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="co"># frmla &lt;- bf(n | weights(w_n) ~ t2(x, z), family = poisson(link = "log")) + </span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="co">#   bf(y | weights(w_y) ~ t2(x, z), family = gaussian())</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="backend" class="level1">
<h1>Backend</h1>
<div class="cell-container"><div class="cell-decorator"><pre>In [10]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># m &lt;- brm(frmla,</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co">#          prior = priors, </span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">#          chains = 1,</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co">#          data = datasets$generated[[1]], </span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co">#          backend = "cmdstanr")</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(m, nvariables = 7)</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(m)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [11]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>priors <span class="ot">&lt;-</span> <span class="fu">prior</span>(<span class="fu">normal</span>(.<span class="dv">5</span>,.<span class="dv">1</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>, <span class="at">resp =</span> <span class="st">"y"</span>) <span class="sc">+</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">1</span>,.<span class="dv">1</span>), <span class="at">class =</span> <span class="st">"b"</span>, <span class="at">coef =</span> <span class="st">"sxz_1"</span>, <span class="at">resp =</span> <span class="st">"y"</span>) <span class="sc">+</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="sc">-</span><span class="dv">1</span>,.<span class="dv">1</span>), <span class="at">class =</span> <span class="st">"b"</span>, <span class="at">coef =</span> <span class="st">"sxz_2"</span>, <span class="at">resp =</span> <span class="st">"y"</span>) <span class="sc">+</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">1</span>,.<span class="dv">1</span>), <span class="at">class =</span> <span class="st">"sds"</span>, <span class="at">resp =</span> <span class="st">"y"</span>) <span class="sc">+</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(.<span class="dv">1</span>,.<span class="dv">01</span>), <span class="at">class =</span> <span class="st">"sigma"</span>, <span class="at">resp =</span> <span class="st">"y"</span>) <span class="sc">+</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,.<span class="dv">001</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>, <span class="at">resp =</span> <span class="st">"x"</span>) <span class="sc">+</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="sc">-</span><span class="fl">1.1</span>,.<span class="dv">001</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>, <span class="at">resp =</span> <span class="st">"z"</span>) <span class="sc">+</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">3</span>,.<span class="dv">001</span>), <span class="at">class =</span> <span class="st">"phi"</span>, <span class="at">resp =</span> <span class="st">"x"</span>) <span class="sc">+</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">3</span>,.<span class="dv">001</span>), <span class="at">class =</span> <span class="st">"phi"</span>, <span class="at">resp =</span> <span class="st">"z"</span>)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>frmla <span class="ot">&lt;-</span> <span class="fu">bf</span>(x <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="fu">Beta</span>(<span class="at">link =</span> <span class="st">"logit"</span>)) <span class="sc">+</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(z <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="fu">Beta</span>(<span class="at">link =</span> <span class="st">"logit"</span>)) <span class="sc">+</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, z, <span class="at">k =</span> <span class="dv">10</span>), <span class="at">family =</span> <span class="fu">gaussian</span>())</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>f_backend <span class="ot">&lt;-</span> <span class="fu">SBC_backend_brms</span>(frmla,</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>                              <span class="at">prior =</span> priors, </span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>                              <span class="at">chains =</span> <span class="dv">1</span>,</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>                              <span class="at">iter =</span> <span class="dv">2000</span>,</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>                              <span class="at">template_data =</span> datasets<span class="sc">$</span>generated[[<span class="dv">1</span>]],</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>                              <span class="at">out_stan_file =</span> <span class="fu">file.path</span>(cache_dir, </span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>                                                               <span class="st">"case_study_II.stan"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Setting 'rescor' to FALSE by default for this model</code></pre>
</div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [12]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">compute_SBC</span>(<span class="at">datasets =</span> datasets, </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">backend =</span> f_backend, </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">cache_mode =</span> <span class="st">"results"</span>, </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">cache_location =</span> <span class="fu">file.path</span>(cache_dir,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>                                                        <span class="st">"SBC_results_case_study_II"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Results loaded from cache file 'SBC_results_case_study_II'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> - 7 (35%) fits had at least one Rhat &gt; 1.01. Largest Rhat was 2.124.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> - 2 (10%) fits had tail ESS undefined or less than half of the maximum rank, potentially skewing 
the rank statistics. The lowest tail ESS was 11.
 If the fits look good otherwise, increasing `thin_ranks` (via recompute_SBC_statistics) 
or number of posterior draws (by refitting) might help.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> - 1 (5%) fits had divergent transitions. Maximum number of divergences was 753.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> - 2 (10%) fits had iterations that saturated max treedepth. Maximum number of max treedepth was 999.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> - 1 (5%) fits had low BFMI.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> - 20 (100%) fits had some steps rejected. Maximum number of rejections was 13.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Not all diagnostics are OK.
You can learn more by inspecting $default_diagnostics, $backend_diagnostics 
and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</code></pre>
</div>
</div></div>
</section>
<section id="visualize-bivariate-smooth-at-first-four-simulation-runs" class="level1">
<h1>Visualize bivariate smooth at first four simulation runs</h1>
<div class="cell-container"><div class="cell-decorator"><pre>In [13]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>nd <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="st">'x'</span> <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> .<span class="dv">02</span>), <span class="st">'z'</span> <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> .<span class="dv">02</span>))</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>p_list <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="dv">4</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (r <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>) {</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> results<span class="sc">$</span>fits[[r]]</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">fitted</span>(<span class="at">object =</span> m, <span class="at">newdata =</span> nd)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  nd<span class="sc">$</span>fit_y <span class="ot">&lt;-</span> fit[, <span class="st">'Estimate'</span>, <span class="st">'y'</span>]</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  p_list[[r]] <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> nd, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> z)) <span class="sc">+</span> </span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_raster</span>(<span class="fu">aes</span>(<span class="at">fill =</span> fit_y)) <span class="sc">+</span> </span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_continuous_sequential</span>(<span class="at">pal =</span> <span class="st">"Grays"</span>, <span class="at">l1 =</span> <span class="dv">0</span>, <span class="at">l2 =</span> <span class="dv">70</span>) <span class="sc">+</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> m<span class="sc">$</span>data, <span class="fu">aes</span>(<span class="at">color =</span> y), <span class="at">alpha =</span> .<span class="dv">8</span>) <span class="sc">+</span> </span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_continuous_sequential</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="at">n =</span> <span class="dv">3</span>), </span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">pal =</span> <span class="st">"Grays"</span>, <span class="at">l1 =</span> <span class="dv">0</span>, <span class="at">l2 =</span> <span class="dv">70</span>, <span class="at">rev =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># colorspace::scale_color_continuous_sequential(pal = "Rocket") +</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">color =</span> <span class="st">"y:"</span>, <span class="at">fill =</span> <span class="st">"E(Y | x, z):"</span>, </span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"Simulation run "</span>, r, <span class="st">":"</span>)) <span class="sc">+</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'top'</span>) <span class="sc">+</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">vjust =</span> .<span class="dv">8</span>))</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> p_list, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="">
<figure class="figure">
<p class=""><a href="case-study-II_files/figure-html/unnamed-chunk-13-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="case-study-II_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="960"></a></p>
</figure>
</div>
</div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [14]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pdf</span>(<span class="st">"20241219_case_study_II_bivariate_smooth_r1to4.pdf"</span>, </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">height =</span> <span class="dv">10</span>, <span class="at">width =</span> <span class="dv">10</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> p_list, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">dev.off</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [15]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># results &lt;- readRDS(file = "./SBC_cache/SBC_results_case_study_II.rds")</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co"># tmp &lt;- results$result$fits[[1]]</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co"># tmp &lt;- as.matrix(tmp)</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co"># colnames(tmp)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [16]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># results$backend_diagnostics</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(results$fits[[1]])</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(results$fits[[2]])</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(results$fits[[3]])</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(results$fits[[4]])</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(results$fits[[5]])</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(results$fits[[1]], nvariables = 7)</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(results$fits[[2]], nvariables = 7)</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(results$fits[[3]], nvariables = 7)</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(results$fits[[2]], nvariables = 7)</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="co"># as.data.frame(datasets$variables)[2, ]</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(results$fits[[3]])</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(results$fits[[4]])</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(results$fits[[5]])</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="qoi-check" class="level1">
<h1>QOI-Check</h1>
<div class="cell-container"><div class="cell-decorator"><pre>In [17]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>f_postprocessing <span class="ot">&lt;-</span> <span class="cf">function</span>(m, b, <span class="at">focus_on =</span> <span class="st">'x'</span>, <span class="at">at =</span> .<span class="dv">8</span>, </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>                             <span class="at">integration_grid =</span> <span class="fu">seq</span>(.<span class="dv">025</span>, .<span class="dv">975</span>, <span class="at">by =</span> .<span class="dv">05</span>)) {</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(focus_on <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">'x'</span>, <span class="st">'z'</span>))) {</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"'focus_on' must be either 'x' or 'z'."</span>)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  nd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">'variable1'</span> <span class="ot">=</span> at)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  nd <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">expand.grid</span>(<span class="st">'variable1'</span> <span class="ot">=</span> nd<span class="sc">$</span>variable1, </span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'variable2'</span> <span class="ot">=</span> integration_grid))</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(nd) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'x'</span>, <span class="st">'z'</span>)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">fitted</span>(m, <span class="at">newdata =</span> nd, <span class="at">dpar =</span> <span class="st">"mu"</span>, <span class="at">summary =</span> F)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (focus_on <span class="sc">==</span> <span class="st">'x'</span>) {</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    phi <span class="ot">&lt;-</span> <span class="fu">fitted</span>(m, <span class="at">newdata =</span> nd, <span class="at">resp =</span> <span class="st">"z"</span>, <span class="at">dpar =</span> <span class="st">"phi"</span>, <span class="at">summary =</span> F)</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    shape1 <span class="ot">&lt;-</span> fit[, , <span class="st">"z"</span>] <span class="sc">*</span> phi</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    shape2 <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> fit[, , <span class="st">"z"</span>]) <span class="sc">*</span> phi</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> shape1 <span class="sc">*</span> <span class="dv">0</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(nd)) {</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>      d[, i] <span class="ot">&lt;-</span> <span class="fu">dbeta</span>(<span class="at">x =</span> nd<span class="sc">$</span>z[i], <span class="at">shape1 =</span> shape1[, i], <span class="at">shape2 =</span> shape2[, i])</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (focus_on <span class="sc">==</span> <span class="st">'z'</span>) {</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>    phi <span class="ot">&lt;-</span> <span class="fu">fitted</span>(m, <span class="at">newdata =</span> nd, <span class="at">resp =</span> <span class="st">"x"</span>, <span class="at">dpar =</span> <span class="st">"phi"</span>, <span class="at">summary =</span> F)</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>    shape1 <span class="ot">&lt;-</span> fit[, , <span class="st">"x"</span>] <span class="sc">*</span> phi</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>    shape2 <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> fit[, , <span class="st">"x"</span>]) <span class="sc">*</span> phi</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> shape1 <span class="sc">*</span> <span class="dv">0</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(nd)) {</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>      d[, i] <span class="ot">&lt;-</span> <span class="fu">dbeta</span>(<span class="at">x =</span> nd<span class="sc">$</span>x[i], <span class="at">shape1 =</span> shape1[, i], <span class="at">shape2 =</span> shape2[, i])</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> d <span class="sc">/</span> <span class="fu">apply</span>(d, <span class="at">MAR =</span> <span class="dv">1</span>, <span class="at">FUN =</span> sum)</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">apply</span>(d, <span class="at">MAR =</span> <span class="dv">1</span>, <span class="at">FUN =</span> sum) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(tmp <span class="sc">&gt;</span> <span class="fl">1e-10</span>)) {</span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"No proper calculation of weights!"</span>)</span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">'Weighted'</span> <span class="ot">=</span> <span class="fu">apply</span>(d <span class="sc">*</span> fit[, , <span class="st">'y'</span>], <span class="at">MAR =</span> <span class="dv">1</span>, <span class="at">FUN =</span> sum), </span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>              <span class="st">'Unweighted'</span> <span class="ot">=</span> <span class="fu">apply</span>(fit[, , <span class="st">'y'</span>], <span class="at">MAR =</span> <span class="dv">1</span>, <span class="at">FUN =</span> mean)))</span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>ranks_rgpp <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>) {</span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">"j = "</span>, j, <span class="st">":</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  f_postprocessing_fast():</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  "</span>)</span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> all_weighted <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>  x_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(.<span class="dv">025</span>, .<span class="dv">975</span>, <span class="at">by =</span> .<span class="dv">05</span>)</span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x_grid)) {</span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> x_grid[i]</span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>    tmp <span class="ot">&lt;-</span> <span class="fu">f_postprocessing</span>(results<span class="sc">$</span>fits[[j]], </span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">as.data.frame</span>(datasets<span class="sc">$</span>variables)[j, ], </span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>                            <span class="at">focus_on =</span> <span class="st">'x'</span>, x, </span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">seq</span>(.<span class="dv">0005</span>, .<span class="dv">9995</span>, <span class="at">by =</span> .<span class="dv">001</span>))</span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a>    all_weighted <span class="ot">&lt;-</span> <span class="fu">cbind</span>(all_weighted, tmp[[<span class="st">'Weighted'</span>]])</span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (method <span class="cf">in</span> <span class="fu">c</span>(<span class="st">'Weighted'</span>, <span class="st">'Unweighted'</span>)) {</span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a>      res <span class="ot">&lt;-</span> <span class="fu">rbind</span>(res, </span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">data.frame</span>(<span class="st">'x'</span> <span class="ot">=</span> x, </span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a>                              <span class="st">'y'</span> <span class="ot">=</span> <span class="fu">mean</span>(tmp[[method]]), </span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a>                              <span class="st">'method'</span> <span class="ot">=</span> method, </span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a>                              <span class="st">'stat'</span> <span class="ot">=</span> <span class="st">'Mean'</span>))</span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a>      res <span class="ot">&lt;-</span> <span class="fu">rbind</span>(res, </span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">data.frame</span>(<span class="st">'x'</span> <span class="ot">=</span> x, </span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a>                              <span class="st">'y'</span> <span class="ot">=</span> <span class="fu">median</span>(tmp[[method]]), </span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a>                              <span class="st">'method'</span> <span class="ot">=</span> method, </span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a>                              <span class="st">'stat'</span> <span class="ot">=</span> <span class="st">'Median'</span>))</span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a>      res <span class="ot">&lt;-</span> <span class="fu">rbind</span>(res, </span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">data.frame</span>(<span class="st">'x'</span> <span class="ot">=</span> x, </span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a>                              <span class="st">'y'</span> <span class="ot">=</span> <span class="fu">quantile</span>(tmp[[method]], <span class="at">probs =</span> .<span class="dv">025</span>), </span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a>                              <span class="st">'method'</span> <span class="ot">=</span> method, </span>
<span id="cb42-66"><a href="#cb42-66" aria-hidden="true" tabindex="-1"></a>                              <span class="st">'stat'</span> <span class="ot">=</span> <span class="st">'2.5% quantile'</span>))</span>
<span id="cb42-67"><a href="#cb42-67" aria-hidden="true" tabindex="-1"></a>      res <span class="ot">&lt;-</span> <span class="fu">rbind</span>(res, </span>
<span id="cb42-68"><a href="#cb42-68" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">data.frame</span>(<span class="st">'x'</span> <span class="ot">=</span> x, </span>
<span id="cb42-69"><a href="#cb42-69" aria-hidden="true" tabindex="-1"></a>                              <span class="st">'y'</span> <span class="ot">=</span> <span class="fu">quantile</span>(tmp[[method]], <span class="at">probs =</span> .<span class="dv">975</span>), </span>
<span id="cb42-70"><a href="#cb42-70" aria-hidden="true" tabindex="-1"></a>                              <span class="st">'method'</span> <span class="ot">=</span> method, </span>
<span id="cb42-71"><a href="#cb42-71" aria-hidden="true" tabindex="-1"></a>                              <span class="st">'stat'</span> <span class="ot">=</span> <span class="st">'97.5% quantile'</span>))</span>
<span id="cb42-72"><a href="#cb42-72" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb42-73"><a href="#cb42-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"."</span>)</span>
<span id="cb42-74"><a href="#cb42-74" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb42-75"><a href="#cb42-75" aria-hidden="true" tabindex="-1"></a>  res0 <span class="ot">&lt;-</span> res</span>
<span id="cb42-76"><a href="#cb42-76" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Compare to GAM s() + s() + ti()</span></span>
<span id="cb42-77"><a href="#cb42-77" aria-hidden="true" tabindex="-1"></a>  <span class="do">## https://cran.r-project.org/web/packages/mgcv/mgcv.pdf</span></span>
<span id="cb42-78"><a href="#cb42-78" aria-hidden="true" tabindex="-1"></a>  <span class="do">## p. 79:</span></span>
<span id="cb42-79"><a href="#cb42-79" aria-hidden="true" tabindex="-1"></a>  <span class="do">## "Sometimes it is interesting to specify smooth models with a main </span></span>
<span id="cb42-80"><a href="#cb42-80" aria-hidden="true" tabindex="-1"></a>  <span class="do">##  effects + interaction structure such as</span></span>
<span id="cb42-81"><a href="#cb42-81" aria-hidden="true" tabindex="-1"></a>  <span class="do">##  E(yi) = f1(xi) + f2(zi) + f3(xi, zi)</span></span>
<span id="cb42-82"><a href="#cb42-82" aria-hidden="true" tabindex="-1"></a>  <span class="do">##  [...]</span></span>
<span id="cb42-83"><a href="#cb42-83" aria-hidden="true" tabindex="-1"></a>  <span class="do">##  for example. </span></span>
<span id="cb42-84"><a href="#cb42-84" aria-hidden="true" tabindex="-1"></a>  <span class="do">##  Such models should be set up using ti terms in the model formula. </span></span>
<span id="cb42-85"><a href="#cb42-85" aria-hidden="true" tabindex="-1"></a>  <span class="do">##  For example:</span></span>
<span id="cb42-86"><a href="#cb42-86" aria-hidden="true" tabindex="-1"></a>  <span class="do">##  y ~ ti(x) + ti(z) + ti(x,z), </span></span>
<span id="cb42-87"><a href="#cb42-87" aria-hidden="true" tabindex="-1"></a>  <span class="do">##  [...]</span></span>
<span id="cb42-88"><a href="#cb42-88" aria-hidden="true" tabindex="-1"></a>  <span class="do">##  The ti terms produce interactions with the component main effects </span></span>
<span id="cb42-89"><a href="#cb42-89" aria-hidden="true" tabindex="-1"></a>  <span class="do">##  excluded appropriately. (There is in fact no need to use ti terms </span></span>
<span id="cb42-90"><a href="#cb42-90" aria-hidden="true" tabindex="-1"></a>  <span class="do">##  for the main effects here, s terms could also be used.)"                                                        ## "[...] in fact no need to use ti terms for the main effects here, </span></span>
<span id="cb42-91"><a href="#cb42-91" aria-hidden="true" tabindex="-1"></a>  <span class="do">##  s terms could also be used."</span></span>
<span id="cb42-92"><a href="#cb42-92" aria-hidden="true" tabindex="-1"></a>  m_gam <span class="ot">&lt;-</span> <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x) <span class="sc">+</span> <span class="fu">s</span>(z) <span class="sc">+</span> <span class="fu">ti</span>(x, z), <span class="at">data =</span> datasets<span class="sc">$</span>generated[[j]])</span>
<span id="cb42-93"><a href="#cb42-93" aria-hidden="true" tabindex="-1"></a>  nd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> x_grid, <span class="at">z =</span> x_grid)</span>
<span id="cb42-94"><a href="#cb42-94" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">predict</span>(m_gam, <span class="at">type =</span> <span class="st">"terms"</span>, <span class="at">newdata =</span> nd)</span>
<span id="cb42-95"><a href="#cb42-95" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">rbind</span>(res, </span>
<span id="cb42-96"><a href="#cb42-96" aria-hidden="true" tabindex="-1"></a>               <span class="fu">data.frame</span>(<span class="at">x =</span> x_grid, </span>
<span id="cb42-97"><a href="#cb42-97" aria-hidden="true" tabindex="-1"></a>                          <span class="at">y =</span> tmp[, <span class="st">'s(x)'</span>] <span class="sc">+</span> <span class="fu">coef</span>(m_gam)[<span class="dv">1</span>], </span>
<span id="cb42-98"><a href="#cb42-98" aria-hidden="true" tabindex="-1"></a>                          <span class="at">method =</span> <span class="st">"mgcv::gam: s(x) [model: y ~ s(x) + s(z) + ti(x, z)]"</span>, </span>
<span id="cb42-99"><a href="#cb42-99" aria-hidden="true" tabindex="-1"></a>                          <span class="at">stat =</span> <span class="st">"Effect"</span>))</span>
<span id="cb42-100"><a href="#cb42-100" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ############################################</span></span>
<span id="cb42-101"><a href="#cb42-101" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Reference grid posterior predictive check ##</span></span>
<span id="cb42-102"><a href="#cb42-102" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ############################################</span></span>
<span id="cb42-103"><a href="#cb42-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb42-104"><a href="#cb42-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  reference grid prior prediction:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb42-105"><a href="#cb42-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  "</span>)</span>
<span id="cb42-106"><a href="#cb42-106" aria-hidden="true" tabindex="-1"></a>  x_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(.<span class="dv">025</span>, .<span class="dv">975</span>, <span class="at">by =</span> .<span class="dv">05</span>)</span>
<span id="cb42-107"><a href="#cb42-107" aria-hidden="true" tabindex="-1"></a>  ref_grid_prior_mean_y_x <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">length</span>(x_grid))</span>
<span id="cb42-108"><a href="#cb42-108" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x_grid)) {</span>
<span id="cb42-109"><a href="#cb42-109" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(datasets<span class="sc">$</span>variables)[j, ]</span>
<span id="cb42-110"><a href="#cb42-110" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> <span class="fu">f_generate_xz</span>(<span class="at">N =</span> <span class="dv">10000</span>, </span>
<span id="cb42-111"><a href="#cb42-111" aria-hidden="true" tabindex="-1"></a>                       <span class="at">b_Intercept =</span> <span class="fu">as.numeric</span>(b[<span class="st">'b_z_Intercept'</span>]), </span>
<span id="cb42-112"><a href="#cb42-112" aria-hidden="true" tabindex="-1"></a>                       <span class="at">phi =</span> <span class="fu">as.numeric</span>(b[<span class="st">'phi_z'</span>]))</span>
<span id="cb42-113"><a href="#cb42-113" aria-hidden="true" tabindex="-1"></a>    dat_xz <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">'x'</span> <span class="ot">=</span> x_grid[i], <span class="st">'z'</span> <span class="ot">=</span> z)</span>
<span id="cb42-114"><a href="#cb42-114" aria-hidden="true" tabindex="-1"></a>    sm <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">smoothCon</span>(<span class="at">object =</span> <span class="fu">s</span>(x, z, <span class="at">k =</span> <span class="dv">10</span>), <span class="at">data =</span> results<span class="sc">$</span>fits[[j]]<span class="sc">$</span>data,</span>
<span id="cb42-115"><a href="#cb42-115" aria-hidden="true" tabindex="-1"></a>                          <span class="at">absorb.cons =</span> <span class="cn">TRUE</span>, <span class="at">modCon =</span> <span class="dv">3</span>, <span class="at">diagonal.penalty =</span> <span class="cn">TRUE</span>)</span>
<span id="cb42-116"><a href="#cb42-116" aria-hidden="true" tabindex="-1"></a>    sm2r <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">smooth2random</span>(<span class="at">object =</span> sm[[<span class="dv">1</span>]], <span class="at">vnames =</span> <span class="fu">c</span>(<span class="st">'x'</span>, <span class="st">'z'</span>), <span class="at">type =</span> <span class="dv">2</span>)</span>
<span id="cb42-117"><a href="#cb42-117" aria-hidden="true" tabindex="-1"></a>    sm2r_pre <span class="ot">&lt;-</span> <span class="fu">s2rPred</span>(<span class="at">sm =</span> sm[[<span class="dv">1</span>]], <span class="at">re =</span> sm2r, <span class="at">data =</span> dat_xz)</span>
<span id="cb42-118"><a href="#cb42-118" aria-hidden="true" tabindex="-1"></a>    Xf <span class="ot">&lt;-</span> sm2r_pre[[<span class="st">'Xf'</span>]]</span>
<span id="cb42-119"><a href="#cb42-119" aria-hidden="true" tabindex="-1"></a>    Xr <span class="ot">&lt;-</span> sm2r_pre[[<span class="st">'rand'</span>]][[<span class="st">'Xr'</span>]]</span>
<span id="cb42-120"><a href="#cb42-120" aria-hidden="true" tabindex="-1"></a>    etaf <span class="ot">&lt;-</span> Xf <span class="sc">%*%</span> <span class="fu">as.numeric</span>(b[<span class="fu">grep</span>(<span class="fu">names</span>(b), <span class="at">pattern =</span> <span class="st">"bs_"</span>, <span class="at">fixed =</span> T)])</span>
<span id="cb42-121"><a href="#cb42-121" aria-hidden="true" tabindex="-1"></a>    etar <span class="ot">&lt;-</span> Xr <span class="sc">%*%</span> <span class="fu">as.numeric</span>(b[<span class="fu">grep</span>(<span class="fu">names</span>(b), <span class="at">pattern =</span> <span class="st">"s_y_sxz["</span>, <span class="at">fixed =</span> T)])</span>
<span id="cb42-122"><a href="#cb42-122" aria-hidden="true" tabindex="-1"></a>    eta <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(b[<span class="st">'b_y_Intercept'</span>]) <span class="sc">+</span> etaf <span class="sc">+</span> etar</span>
<span id="cb42-123"><a href="#cb42-123" aria-hidden="true" tabindex="-1"></a>    dat_xz <span class="ot">&lt;-</span> <span class="fu">f_generate_y</span>(dat_xz, <span class="fu">as.numeric</span>(eta), <span class="fu">as.numeric</span>(b[<span class="st">"sigma_y"</span>]))</span>
<span id="cb42-124"><a href="#cb42-124" aria-hidden="true" tabindex="-1"></a>    ref_grid_prior_mean_y_x[i] <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat_xz<span class="sc">$</span>y)</span>
<span id="cb42-125"><a href="#cb42-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"."</span>)</span>
<span id="cb42-126"><a href="#cb42-126" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb42-127"><a href="#cb42-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb42-128"><a href="#cb42-128" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">rbind</span>(res, </span>
<span id="cb42-129"><a href="#cb42-129" aria-hidden="true" tabindex="-1"></a>               <span class="fu">data.frame</span>(<span class="at">x =</span> x_grid, </span>
<span id="cb42-130"><a href="#cb42-130" aria-hidden="true" tabindex="-1"></a>                          <span class="at">y =</span> ref_grid_prior_mean_y_x,</span>
<span id="cb42-131"><a href="#cb42-131" aria-hidden="true" tabindex="-1"></a>                          <span class="at">method =</span> <span class="st">"Reference grid prior prediction (N = 1000)"</span>, </span>
<span id="cb42-132"><a href="#cb42-132" aria-hidden="true" tabindex="-1"></a>                          <span class="at">stat =</span> <span class="st">"Mean"</span>))</span>
<span id="cb42-133"><a href="#cb42-133" aria-hidden="true" tabindex="-1"></a>  res<span class="sc">$</span>stat <span class="ot">&lt;-</span> <span class="fu">factor</span>(res<span class="sc">$</span>stat, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Mean"</span>, <span class="st">"Median"</span>, <span class="st">"2.5% quantile"</span>, </span>
<span id="cb42-134"><a href="#cb42-134" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">"97.5% quantile"</span>, <span class="st">"Effect"</span>))</span>
<span id="cb42-135"><a href="#cb42-135" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (j <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb42-136"><a href="#cb42-136" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">subset</span>(res, stat <span class="sc">!=</span> <span class="st">"Median"</span>), <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span> </span>
<span id="cb42-137"><a href="#cb42-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> <span class="fu">paste0</span>(stat, method), </span>
<span id="cb42-138"><a href="#cb42-138" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> stat)) <span class="sc">+</span> <span class="co">#, color = method</span></span>
<span id="cb42-139"><a href="#cb42-139" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>, <span class="at">legend.box=</span><span class="st">"vertical"</span>, <span class="at">legend.margin=</span><span class="fu">margin</span>()) <span class="sc">+</span></span>
<span id="cb42-140"><a href="#cb42-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">color =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb42-141"><a href="#cb42-141" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb42-142"><a href="#cb42-142" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> method) <span class="sc">+</span></span>
<span id="cb42-143"><a href="#cb42-143" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">color =</span> <span class="st">"Method:"</span>, <span class="at">linetype =</span> <span class="st">"Statistic:"</span>)</span>
<span id="cb42-144"><a href="#cb42-144" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb42-145"><a href="#cb42-145" aria-hidden="true" tabindex="-1"></a>  rgpp_all_weighted <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">subset</span>(res, </span>
<span id="cb42-146"><a href="#cb42-146" aria-hidden="true" tabindex="-1"></a>                           method <span class="sc">==</span> <span class="st">"reference grid prior prediction (N = 1000)"</span>)<span class="sc">$</span>y, </span>
<span id="cb42-147"><a href="#cb42-147" aria-hidden="true" tabindex="-1"></a>                           all_weighted)</span>
<span id="cb42-148"><a href="#cb42-148" aria-hidden="true" tabindex="-1"></a>  ranks_rgpp <span class="ot">&lt;-</span> <span class="fu">cbind</span>(ranks_rgpp, </span>
<span id="cb42-149"><a href="#cb42-149" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">apply</span>(rgpp_all_weighted, <span class="at">MAR =</span> <span class="dv">2</span>, </span>
<span id="cb42-150"><a href="#cb42-150" aria-hidden="true" tabindex="-1"></a>                            <span class="at">FUN =</span> <span class="cf">function</span>(x){<span class="fu">mean</span>(x[<span class="sc">-</span><span class="dv">1</span>] <span class="sc">&gt;</span> x[<span class="dv">1</span>])}))</span>
<span id="cb42-151"><a href="#cb42-151" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-152"><a href="#cb42-152" aria-hidden="true" tabindex="-1"></a>ranks <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">'rank'</span> <span class="ot">=</span> reshape2<span class="sc">::</span><span class="fu">melt</span>(ranks_rgpp)<span class="sc">$</span>value, </span>
<span id="cb42-153"><a href="#cb42-153" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'max_rank'</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb42-154"><a href="#cb42-154" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'variable'</span> <span class="ot">=</span> reshape2<span class="sc">::</span><span class="fu">melt</span>(ranks_rgpp)<span class="sc">$</span>Var1,</span>
<span id="cb42-155"><a href="#cb42-155" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'sim_id'</span> <span class="ot">=</span> reshape2<span class="sc">::</span><span class="fu">melt</span>(ranks_rgpp)<span class="sc">$</span>Var2)</span>
<span id="cb42-156"><a href="#cb42-156" aria-hidden="true" tabindex="-1"></a>ranks<span class="sc">$</span>rank <span class="ot">&lt;-</span> ranks<span class="sc">$</span>rank <span class="sc">*</span> <span class="dv">1000</span></span>
<span id="cb42-157"><a href="#cb42-157" aria-hidden="true" tabindex="-1"></a>ranks<span class="sc">$</span>rank <span class="ot">&lt;-</span> ranks<span class="sc">$</span>rank <span class="sc">-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">runif</span>(<span class="fu">nrow</span>(ranks))</span>
<span id="cb42-158"><a href="#cb42-158" aria-hidden="true" tabindex="-1"></a>ranks<span class="sc">$</span>max_rank <span class="ot">&lt;-</span> ranks<span class="sc">$</span>max_rank <span class="sc">*</span> <span class="dv">1000</span></span>
<span id="cb42-159"><a href="#cb42-159" aria-hidden="true" tabindex="-1"></a>ranks<span class="sc">$</span>variable <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">paste</span>(<span class="st">"x:"</span>, x_grid[ranks<span class="sc">$</span>variable]), </span>
<span id="cb42-160"><a href="#cb42-160" aria-hidden="true" tabindex="-1"></a>                         <span class="at">levels =</span> <span class="fu">paste</span>(<span class="st">"x:"</span>, x_grid))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [18]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">#save(ranks, file = "20241218_ranks.RData")</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="co"># save(p, file = "20241218_p.RData")</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="at">file =</span> <span class="st">"20241218_ranks.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [19]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="fu">dat_ecdf_diff</span>(ranks, <span class="at">variables =</span> <span class="fu">levels</span>(ranks<span class="sc">$</span>variable), <span class="at">K =</span> <span class="dv">40</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>col_color <span class="ot">&lt;-</span> <span class="fu">c</span>(colorspace<span class="sc">::</span><span class="fu">sequential_hcl</span>(<span class="at">n =</span> <span class="dv">20</span>, <span class="at">pal =</span> <span class="st">"Grays"</span>)[<span class="dv">10</span>], <span class="st">"black"</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>col_fill <span class="ot">&lt;-</span> <span class="fu">c</span>(colorspace<span class="sc">::</span><span class="fu">sequential_hcl</span>(<span class="at">n =</span> <span class="dv">20</span>, <span class="at">pal =</span> <span class="st">"Grays"</span>)[<span class="dv">10</span>], <span class="st">"black"</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(col_color) <span class="ot">&lt;-</span> <span class="fu">names</span>(col_fill) <span class="ot">&lt;-</span> </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"theoretical CDF"</span>, <span class="st">"sample ECDF"</span>)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>l <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'theoretical CDF'</span> <span class="ot">=</span> <span class="fu">expression</span>(<span class="st">"Theoretical CDF"</span>), </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>       <span class="st">'sample ECDF'</span> <span class="ot">=</span> <span class="fu">expression</span>(<span class="st">"Sample ECDF"</span>))</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(tmp<span class="sc">$</span>ecdf_df, <span class="fu">aes</span>(<span class="at">color =</span> type, <span class="at">fill =</span> type)) <span class="sc">+</span> </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> tmp<span class="sc">$</span>limits_df_trans, </span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">ymax =</span> ymax, <span class="at">ymin =</span> ymin), <span class="at">alpha =</span> .<span class="dv">33</span>, </span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>              <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> z, <span class="at">y =</span> z_diff, <span class="at">group =</span> variable)) <span class="sc">+</span> </span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">""</span>, <span class="at">values =</span> col_color, <span class="at">labels =</span> l) <span class="sc">+</span> </span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">name =</span> <span class="st">""</span>, <span class="at">values =</span> col_fill, <span class="at">labels =</span> l) <span class="sc">+</span> </span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span> </span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="cn">NULL</span>) <span class="sc">+</span> </span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="cn">NULL</span>) <span class="sc">+</span> </span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>variable) <span class="sc">+</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">b =</span> <span class="dv">0</span>, <span class="at">t =</span> <span class="dv">0</span>))) <span class="sc">+</span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="">
<figure class="figure">
<p class=""><a href="case-study-II_files/figure-html/unnamed-chunk-19-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="case-study-II_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="960"></a></p>
</figure>
</div>
</div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [20]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pdf</span>(<span class="st">"20241219_results_QOI_check_case_study_II.pdf"</span>, </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">height =</span> <span class="dv">10</span>, <span class="at">width =</span> <span class="dv">13</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(tmp<span class="sc">$</span>ecdf_df, <span class="fu">aes</span>(<span class="at">color =</span> type, <span class="at">fill =</span> type)) <span class="sc">+</span> </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> tmp<span class="sc">$</span>limits_df_trans, </span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">ymax =</span> ymax, <span class="at">ymin =</span> ymin), <span class="at">alpha =</span> .<span class="dv">33</span>, </span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> z, <span class="at">y =</span> z_diff, <span class="at">group =</span> variable)) <span class="sc">+</span> </span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">""</span>, <span class="at">values =</span> col_color, <span class="at">labels =</span> l) <span class="sc">+</span> </span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">name =</span> <span class="st">""</span>, <span class="at">values =</span> col_fill, <span class="at">labels =</span> l) <span class="sc">+</span> </span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span> </span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="cn">NULL</span>) <span class="sc">+</span> </span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="cn">NULL</span>) <span class="sc">+</span> </span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>variable) <span class="sc">+</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">b =</span> <span class="dv">0</span>, <span class="at">t =</span> <span class="dv">0</span>))) <span class="sc">+</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">dev.off</span>())</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="co"># head(datasets$generated[[1]])</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(data = datasets$generated[[1]], </span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a><span class="co">#        aes(x = x, y = z, fill = y)) + </span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_tile()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="visualise-isolated-effect-of-x-for-1st-simulation-run" class="level1">
<h1>Visualise ‘isolated effect’ of <code>x</code> for 1st simulation run</h1>
<div class="cell-container"><div class="cell-decorator"><pre>In [21]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="at">file =</span> <span class="st">"20241218_p.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [22]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="">
<figure class="figure">
<p class=""><a href="case-study-II_files/figure-html/unnamed-chunk-22-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="case-study-II_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [23]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pdf</span>(<span class="st">"20241219_isolated_x_effect_case_study_II.pdf"</span>, </span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">height =</span> <span class="dv">10</span>, <span class="at">width =</span> <span class="dv">13</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(tmp<span class="sc">$</span>ecdf_df, <span class="fu">aes</span>(<span class="at">color =</span> type, <span class="at">fill =</span> type)) <span class="sc">+</span> </span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> tmp<span class="sc">$</span>limits_df_trans, </span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">ymax =</span> ymax, <span class="at">ymin =</span> ymin), <span class="at">alpha =</span> .<span class="dv">33</span>, </span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> z, <span class="at">y =</span> z_diff, <span class="at">group =</span> variable)) <span class="sc">+</span> </span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">""</span>, <span class="at">values =</span> col_color, <span class="at">labels =</span> l) <span class="sc">+</span> </span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">name =</span> <span class="st">""</span>, <span class="at">values =</span> col_fill, <span class="at">labels =</span> l) <span class="sc">+</span> </span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span> </span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="cn">NULL</span>) <span class="sc">+</span> </span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="cn">NULL</span>) <span class="sc">+</span> </span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>variable) <span class="sc">+</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">b =</span> <span class="dv">0</span>, <span class="at">t =</span> <span class="dv">0</span>))) <span class="sc">+</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">dev.off</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list">
<div id="ref-AllaireEtAl2024" class="csl-entry" role="listitem">
Allaire, J. J., Teague, C., Scheidegger, C., Xie, Y., &amp; Dervieux, C. (2024). <em>Quarto <span>(Version 1.4.553)</span></em>. <a href="https://doi.org/10.5281/zenodo.5960048">https://doi.org/10.5281/zenodo.5960048</a>
</div>
<div id="ref-Bengtsson2021" class="csl-entry" role="listitem">
Bengtsson, H. (2021). A unifying framework for parallel and distributed processing in r using futures. <em>The R Journal</em>, <em>13</em>(2), 208–227. <a href="https://doi.org/10.32614/RJ-2021-048">https://doi.org/10.32614/RJ-2021-048</a>
</div>
<div id="ref-Buerkner2017" class="csl-entry" role="listitem">
Bürkner, P.-C. (2017). <span class="nocase">brms</span>: An <span>R</span> package for <span>Bayesian</span> multilevel models using <span>Stan</span>. <em>Journal of Statistical Software</em>, <em>80</em>(1), 1–28. <a href="https://doi.org/10.18637/jss.v080.i01">https://doi.org/10.18637/jss.v080.i01</a>
</div>
<div id="ref-Buerkner2018" class="csl-entry" role="listitem">
Bürkner, P.-C. (2018). Advanced <span>Bayesian</span> multilevel modeling with the <span>R</span> package <span class="nocase">brms</span>. <em>The R Journal</em>, <em>10</em>(1), 395–411. <a href="https://doi.org/10.32614/RJ-2018-017">https://doi.org/10.32614/RJ-2018-017</a>
</div>
<div id="ref-Buerkner2021" class="csl-entry" role="listitem">
Bürkner, P.-C. (2021). Bayesian item response modeling in <span>R</span> with <span class="nocase">brms</span> and <span>Stan</span>. <em>Journal of Statistical Software</em>, <em>100</em>(5), 1–54. <a href="https://doi.org/10.18637/jss.v100.i05">https://doi.org/10.18637/jss.v100.i05</a>
</div>
<div id="ref-GabryEtAl2024" class="csl-entry" role="listitem">
Gabry, J., Češnovar, R., Johnson, A., &amp; Bronder, S. (2024). <em>Cmdstanr: R interface to ’CmdStan’</em>. <a href="https://mc-stan.org/cmdstanr/">https://mc-stan.org/cmdstanr/</a>
</div>
<div id="ref-LiHuggins2024" class="csl-entry" role="listitem">
Li, J., &amp; Huggins, J. H. (2024). <em>Calibrated model criticism using split predictive checks</em>. <a href="https://arxiv.org/abs/2203.15897">https://arxiv.org/abs/2203.15897</a>
</div>
<div id="ref-ModrakEtAl2023" class="csl-entry" role="listitem">
Modrák, M., Moon, A. H., Kim, S., Bürkner, P., Huurre, N., Faltejsková, K., Gelman, A., &amp; Vehtari, A. (2023). Simulation-based calibration checking for bayesian computation: The choice of test quantities shapes sensitivity. <em>Bayesian Analysis</em>, <em>Advance publication</em>. <a href="https://doi.org/10.1214/23-BA1404">https://doi.org/10.1214/23-BA1404</a>
</div>
<div id="ref-RCoreTeam2024" class="csl-entry" role="listitem">
R Core Team. (2024). <em>R: <span>A Language</span> and <span>Environment</span> for <span>Statistical</span> <span>Computing</span> <span>(Version 4.4.1)</span></em>. R Foundation for Statistical Computing.
</div>
<div id="ref-StaufferEtAl2009" class="csl-entry" role="listitem">
Stauffer, R., Mayr, G. J., Dabernig, M., &amp; Zeileis, A. (2009). Somewhere over the rainbow: How to make effective use of colors in meteorological visualizations. <em>Bulletin of the American Meteorological Society</em>, <em>96</em>(2), 203–216. <a href="https://doi.org/10.1175/BAMS-D-13-00155.1">https://doi.org/10.1175/BAMS-D-13-00155.1</a>
</div>
<div id="ref-Wickham2016" class="csl-entry" role="listitem">
Wickham, H. (2016). <em>ggplot2: Elegant graphics for data analysis</em>. Springer-Verlag New York. <a href="https://ggplot2.tidyverse.org">https://ggplot2.tidyverse.org</a>
</div>
<div id="ref-Wood2011" class="csl-entry" role="listitem">
Wood, S. N. (2011). Fast stable restricted maximum likelihood and marginal likelihood estimation of semiparametric generalized linear models. <em>Journal of the Royal Statistical Society (B)</em>, <em>73</em>(1), 3–36.
</div>
</div>
</section>
     </main>
<!-- /main column -->  <script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>  </div> <!-- /content -->  <script>var lightboxQuarto = GLightbox({"descPosition":"bottom","loop":false,"openEffect":"zoom","closeEffect":"zoom","selector":".lightbox"});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script> 
  
</body></html>